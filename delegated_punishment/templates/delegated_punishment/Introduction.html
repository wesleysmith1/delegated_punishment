{% load otree %}
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gsap@3.0.4/dist/gsap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gsap@3.0.4/dist/Draggable.min.js"></script>

<script src="{% static 'global/js/officer.js' %}"></script>
<script src="{% static 'global/js/harvest.js' %}"></script>
<script src="{% static 'global/js/steal.js' %}"></script>

<link rel="stylesheet" type="text/css" href="{% static 'global/styles/harvest.css' %}"></link>
<link rel="stylesheet" type="text/css" href="{% static 'global/styles/steal.css' %}"></link>
<link rel="stylesheet" type="text/css" href="{% static 'global/styles/officer.css' %}"></link>
<link rel="stylesheet" type="text/css" href="{% static 'global/styles/main.css' %}"></link>

<script>
    // data is rendered on api here, then later read by vue instance
    var player =
    {{ pjson|json }}
    var otokens =
    {{ otokens|json }}
</script>

<div>
    <!-- this section is where we pull data from rendered template -->
    <div class="card bg-light instructions" style="display: none">
        <div class="card-body">
            <h2>
                Player <span id="playerId">{{ player.id_in_group }}</span> <span
                    id="groupPlayerId">{{ player.id_in_group }}</span>
            </h2>
        </div>
    </div>

    {% verbatim %}
    <div id="app">
        <div class="panel game">
            <div id="officerGame" v-if="isOfficer">
                <police-game-component
                        :properties="properties"
                        :officer-units="officerTokens"
                        :investigation-count=investigationCount
                        :prob-culprit="probabilityCulprit"
                        :prob-innocent="probabilityInnocent"
                        @token-drag="tokenDrag"
                        @token-update="tokenUpdate"
                        @investigation-update="investigationUpdate">
                </police-game-component>
            </div>
            <div id="harvestGame" v-else>
                <harvest-items-component
                        v-if="harvest"
                        class="harvest"
                        style="display:flex;"
                        :harvest-status="harvestStatus"
                        @harvest-update="harvestUpdate">
                </harvest-items-component>
                <steal-game-component
                        v-show="!harvest"
                        :properties="properties"
                        :player-group-id="playerGroupId"
                        :player-location="playerLocation"
                        :steal-notification="stealNotification"
                        :investigation-count="investigationCount"
                        :prob-culprit="probabilityCulprit"
                        :prob-innocent="probabilityInnocent"
                        @location-drag="locationDrag"
                        @location-update="locationUpdate">
                </steal-game-component>
            </div>
            <div v-show="!isOfficer" @click='toggle' class='toggle'>{{ harvest ? 'Steal' : 'Harvest'}}</div>
        </div>
        <div class="panel status">
            <div class="balance-container">
                <div>DEBUG: ROI: {{ roi }}</div>
                <div class="balance-label">Balance</div>
                <div class="balance"> {{balance}}</div>
            </div>
            <div class="notifications-container">
                <div class="notifications">
                    <div id="generalFeed" class="messageBox">
                        Notifications:
                        <div v-for="message in messages">
                            <div v-if="playerId == message.p_id">You: {{message}}</div>
                            <div v-else><b>{{message}}</b></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endverbatim %}
    </div>
    {% verbatim %}
    <script>

        let app = new Vue({
            el: '#app',
            components: {
                'police-log-component': policeLogComponent,
                'harvest-items-component': harvestItemsComponent,
                'steal-game-component': stealGameComponent,
                'police-game-component': policeGameComponent,
                'probability-bar-component': probabilityBarComponent,
            },
            data: {
                harvest: true,
                that: this,
                player: {},
                isOfficer: true,
                playerId: null,
                playerGroupId: null,
                playerLocation: {},
                policeLogMessages : [],
                messages: [],
                singleMessage: null,
                properties: [],
                locationCount: 5,
                balance: 0,
                roi: 0,
                harvestItems: [],
                harvestStatus: 0,
                officerTokens: [],
                investigationCount: 0,
                stealNotification: "",
            },
            created: function () {

                this.player = JSON.parse(player);

                this.playerId = document.getElementById('playerId').textContent;
                this.playerGroupId = document.getElementById('groupPlayerId').textContent;
                this.isOfficer = this.playerGroupId == 1

                // this code is for handling page refreshes
                if (!this.isOfficer) {
                    this.playerLocation = {
                        'player': this.playerGroupId,
                        'property': this.player.property,
                        'x': this.player.x,
                        'y': this.player.y
                    } // todo integrate this into app
                } else if (this.isOfficer) {
                    this.officerTokens = JSON.parse(otokens)
                    //console.log(this.officerTokens)
                }

                // player properties
                this.properties = [1, 2, 3, 4]

                let that = this;
                this.gameSocket = new WebSocket('ws://' + window.location.host + '/delegated_punishment/' + this.playerId + '/' + this.playerGroupId + '/'),
                    this.gameSocket.onmessage = function (e) {
                        let data = JSON.parse(e.data);
                        //console.log('UPDATED GAME DATA FROM SERVER BELOW: ')
                        //console.log(data)
                        if (data.personal) {
                            let message = "personal message"
                            that.addMessage(message)
                        } else if (data.intersections) {
                            data.intersections.forEach(function (i) {
                                if (i.convicted)
                                    that.addMessage("Civ punished " + i.convicted + " | Officer bonus " + i.officer_bonus + " | Officer Reprimand: " + (i.officer_reprimand ? i.officer_reprimand : 'N/A'))
                                else
                                    that.addMessage("NOBODY WAS CONVICTED")

                                that.showIntersection(i)
                                if (i.player == that.playerId) {
                                    that.resetLocation()
                                }
                            })
                        } else if (data.balance) { // todo set up a better condition here. it should be
                            that.balance = Math.floor(data.balance);
                            that.roi = data.roi
                        } else if (data.investigation_update || data.investigation_update === 0) { //todo: is there a way to not have to work around truthy 0=false issue?
                            that.investigationCount = data.investigation_update
                            //console.log('INVESTIGATION RESULTS!', that.investigationCount)
                        }

                        // wezza delete this
                        if (data.np_debug) {
                            data.np_debug.forEach(function (np) {
                                console.log('NUMPY DATA BELOW: ')
                                console.log(np)
                            })
                        }
                    };

                this.gameSocket.onclose = function (e) {
                    alert('channel closed');
                    console.error('CHANNEL CLOSED UNEXPECTEDLY');
                };

                this.subscribeToBalance()
            },
            methods: {
                toggle: function() {
                    //console.log('screen toggled')
                    if (this.harvest) {
                        // reset harvest status and send toggle event to db
                        this.harvestReset()
                    } else {
                        // send toggle event to db
                        this.stealToggle()
                    }
                    this.harvest = !this.harvest
                },
                stealToggle: function() {
                    console.log('player toggled to steal screen');
                    // todo: find way to send this to api
                    // screen was toggled to steal
                    //this.gameSocket.send(JSON.stringify({
                    //    'harvest': {status: -2},
                    //    'player_id': this.playerId,
                    //    'group_id': 1,
                    //}));
                },
                harvestReset: function() {
                    //console.log('harvest reset');
                    this.harvestStatus = 0;
                    // screen was toggled and harvest needs to be reset
                    this.gameSocket.send(JSON.stringify({
                        'harvest': {status: -1},
                        'player_id': this.playerId,
                        'group_id': 1,
                    }));
                },
                harvestUpdate: function (status) {
                    this.harvestStatus++;
                    //console.log('harvest status: ' + this.harvestStatus)
                    this.gameSocket.send(JSON.stringify({
                        'harvest': {status: this.harvestStatus},
                        'player_id': this.playerId,
                        'group_id': 1,
                    }));
                    // reset harvest cycle
                    if (this.harvestStatus == 4) {
                        this.harvestStatus = 0;
                        // reset harvest items
                        gsap.to('#seed, #water, #plow, #harvest', 0, {autoAlpha: 1});
                    }
                },
                subscribeToBalance: function () {
                    let that = this
                    setInterval(function () {
                        if (that.gameSocket.readyState == WebSocket.OPEN) {
                            that.gameSocket.send(JSON.stringify({
                                'balance': true,
                                'player_id': that.playerId,
                                'group_id': 1,
                            }));
                        } else {
                            console.log('the web socket is not connected')
                        }
                    }, 1000);
                },
                resetLocation: function () {
                    gsap.to('#location', .5, {x: 0, y: 0})
                },
                tokenDrag: function(token) {
                    //console.log('token drag')
                    //console.log(token)
                    this.gameSocket.send(JSON.stringify({
                        'defend_token_drag': token,
                        'player_id': this.playerId,
                        'group_id': 1, //todo fix this to be variable group id
                    }));
                },
                tokenUpdate: function (token) {
                    //console.log(token)
                    this.gameSocket.send(JSON.stringify({
                        'token': token,
                        'player_id': this.playerId,
                        'group_id': 1, //todo fix this to be variable group id
                    }));
                },
                investigationUpdate: function(item) {
                    //console.log('token ' + item.number + ' set to investigation')
                    //console.log(item)
                    // inform the api that the ite is being dragged
                    item.property = 0
                    this.gameSocket.send(JSON.stringify({
                        'investigation': item,
                        'player_id': this.playerId,
                        'group_id': 1, //todo: fix this to be variable group id
                    }));
                },
                locationDrag: function(location) {
                    //console.log('location drag')
                    this.gameSocket.send(JSON.stringify({
                        'location_token_drag': location,
                        'player_id': this.playerId,
                        'group_id': 1, //todo fix this to be variable group id
                    }));
                },
                locationUpdate: function (location) {
                    //console.log(location)
                    this.gameSocket.send(JSON.stringify({
                        'steal': location,
                        'player_id': this.playerId,
                        'group_id': 1, //todo fix this to be variable group id
                    }));
                },
                showIntersection: function (i) {
                    let isSelf = i.player == this.playerId
                    if (isSelf) {
                        this.stealNotification = "You were caught!"
                        let that = this
                        setTimeout(function () {
                            that.stealNotification = '';
                        }, 2000);
                    }

                    let selector = '#indicator' + i.property + '-' + i.player
                    let tl = gsap.timeline();
                    let left = i.x - 10.5;
                    let right = i.y - 2;
                    //console.log('INDICATOR AT ' + left + ',' + right)
                    tl.to(selector, 0, {left: left, top: right});
                    tl.to(selector, {visibility: 'visible'});
                    tl.to(selector, {visibility: 'hidden', delay: 2})

                },
                addPoliceLogMessage: function(message) {
                    this.policeLogMessages.push(message)
                },
                addMessage(message) {
                    if (message['test']) {
                        this.singleMessage = message['test']
                        return;
                    }
                    this.messages.push(message)
                },
            },
            computed: {
                probabilityCulprit() {
                    if (this.investigationCount == 0)
                        return 0
                    else {
                        return Math.floor((1 / 3 + 2 * (this.investigationCount) / 30) * 100)
                    }
                },
                probabilityInnocent() {
                    if (this.investigationCount == 0)
                        return 0
                    else {
                        return Math.floor((1 / 3 - (this.investigationCount) / 30) * 100)
                    }
                }
            },
        });
    </script>
    {% endverbatim %}
