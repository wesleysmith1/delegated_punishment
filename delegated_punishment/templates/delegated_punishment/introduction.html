{% load otree %}
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gsap@3.0.4/dist/gsap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gsap@3.0.4/dist/Draggable.min.js"></script>

<script src="{% static 'global/js/officer.js' %}"></script>
<script src="{% static 'global/js/harvest.js' %}"></script>
<script src="{% static 'global/js/steal.js' %}"></script>

<link rel="stylesheet" type="text/css" href="{% static 'global/styles/main.css' %}"></link>
<link rel="stylesheet" type="text/css" href="{% static 'global/styles/harvest.css' %}"></link>
<link rel="stylesheet" type="text/css" href="{% static 'global/styles/steal.css' %}"></link>
<link rel="stylesheet" type="text/css" href="{% static 'global/styles/officer.css' %}"></link>


<script>
    // data is rendered on api here, then later read by vue instance
    var rand = {{ rand }}
    var player = {{ pjson|json }}
    var otokens = {{ otokens|json }}
</script>

<div>
    <div class="card bg-light instructions" style="display: none">
        <div class="card-body">
            <h2>
                Player <span id="playerId">{{player.id_in_group}}</span> <span id="groupPlayerId" style="display:none">{{player.id_in_group}}</span>
                <span id="rand">{{rand}}</span>
            </h2>
        </div>
    </div>

    {% verbatim %}
    <div id="app">
        <div class="panel game">
            <div id="officerGame" v-if="isOfficer">
                <police-game-component :properties="properties" :officer-units="officerTokens" v-on:token-update="tokenUpdate"></police-game-component>
            </div>
            <div id="harvestGame" v-else>
                <harvest-items-component class="harvest" v-show="harvest" style="display:flex;" v-on:harvest-update="harvestUpdate"></harvest-items-component>
                <steal-game-component v-show="!harvest" :properties="properties" :player-group-id="playerGroupId" :player-location="playerLocation" :steal-notification="stealNotification" v-on:location-update="locationUpdate"></steal-game-component>
            </div>
            <button v-show="!isOfficer" @click='harvest = !harvest' class='toggle'>{{ harvest ? 'Steal' : 'Harvest'}}</button>
        </div>
        <div class="panel status">
            <div class="balance-container">
                <div>DEBUG: ROI: {{ roi }}</div>
                <div class="balance-label">Balance</div>
                <div class="balance"> {{balance}}</div>
            </div>
            <div class="notifications-container">
                <div>Notifications: {{singleMessage}}</div>
                <div id="generalFeed" class="messageBox">
                    <div v-for="message in messages">
                        <div v-if="playerId == message.p_id">You: {{message}}</div>
                        <div v-else><b>{{message}}</b></div>
                    </div>
                </div>
            </div>
        </div>
        {% endverbatim %}
        <!-- <span>Location: [[ picked ]]</span> -->
    </div>
    {% verbatim %}
<script>

    var app = new Vue({
        // delimiters: ['[[', ']]'],
        el: '#app',
        components: {
            'button-location': buttonLocationComponent,
            'police-log-component': policeLogComponent,
            'property-component': propertyComponent,
            'harvest-items-component': harvestItemsComponent,
            'steal-game-component': stealGameComponent,
            'police-game-component': policeGameComponent,
        },
        data: {
            isOfficer: true,
            harvest: false,
            that: this,
            player: {},
            playerId: null,
            playerGroupId: null,
            playerLocation: {},
            messages: [],
            message: 'No players have moved yet!',
            singleMessage: null,
            activeLocation: -1,
            properties: [],
            locationCount: 5,
            picked: true,
            chatSock: null,
            balance: 0,
            roi: 0,
            balanceIncreasing: true,
            harvestItems: [],
            officerTokens: [],
            stealNotification: "",
        },
        created: function() {

            this.player = JSON.parse(player);

            this.playerId = document.getElementById('playerId').textContent;
            this.playerGroupId = document.getElementById('groupPlayerId').textContent;
            this.isOfficer = this.playerGroupId == 1

            // delete this
            let rand = document.getElementById('rand');
            console.log('rand', rand);

            if (!this.isOfficer) {
                //todo: load location from db
                this.playerLocation = {'player': this.playerGroupId, 'property': this.player.property, 'x': this.player.x, 'y': this.player.y} // todo integrate this into app
            } else if (this.isOfficer) {
                //todo: load officer locations
                // generate objects for officer tokens
                //let officerTokens = JSON.parse(otokens)
                this.officerTokens = JSON.parse(otokens)
                console.log(this.officerTokens);
            }

            // get player properties
            this.properties = [1, 2, 3, 4];

            let that = this;
            this.gameSocket = new WebSocket('ws://' + window.location.host + '/delegated_punishment/' + this.playerId + '/' + this.playerGroupId +'/'),
            this.gameSocket.onmessage = function(e) {
                console.log(e.data);
                let data = JSON.parse(e.data);
                if (data.general) {
                    let message = "general message"
                    that.addMessage(message)
                } else if (data.personal) {
                    let message = "personal message"
                    that.addMessage(message)
                } else if (data.intersections) {
                    data.intersections.forEach(function(i) {
                        console.log('intersection: ', i)

                        if (i.convicted)
                            that.addMessage("Civ punished " + i.convicted + " | Officer bonus" + i.officer_bonus + " - Officer Reprimand: " + i.officer_reprimand)
                        else
                            that.addMessage("NOBODY WAS CONVICTED")

                        that.showIntersection(i)
                        if(i.player == that.playerId) {
                            that.resetLocation()
                        }
                    })
                } else { // todo set up a better condition here. it should be
                    console.log(data)
                    that.balance = Math.floor(data.balance);
                    that.roi = data.roi
                }
            };

            this.subscribeToBalance()

            this.gameSocket.onclose = function(e) {
                alert('channel closed');
                console.error('CHANNEL CLOSED UNEXPECTEDLY');
            };
        },
        methods: {
            subscribeToBalance: function() {
                let that = this
                setInterval(function() {
                    console.log('interval')
                    if (that.gameSocket.readyState == WebSocket.OPEN) {
                        that.gameSocket.send(JSON.stringify({
                            'balance': true,
                            'player_id': that.playerId,
                            'group_id': 1,
                        }));
                    } else {
                        console.log('the web socket is not connected')
                    }
                }, 5000);
            },
            harvestUpdate: function(status) {
                this.gameSocket.send(JSON.stringify({
                    'harvest': status, //current,
                    'player_id': this.playerId,
                    'group_id': 1,
                }));
            },
            resetLocation: function() {
                gsap.to('#location', .5, {x: 0, y: 0})
                //gsap.to('#locationrect', {fill: 'purple'})
                // snap back
            },
            tokenUpdate: function(token) {
                this.gameSocket.send(JSON.stringify({
                    'token': token,
                    'player_id': this.playerId,
                    'group_id': 1, //todo fix this to be variable group id
                }));
            },
            locationUpdate: function(location) {
                console.log(location)
                this.gameSocket.send(JSON.stringify({
                    'steal': location,
                    'player_id': this.playerId,
                    'group_id': 1, //todo fix this to be variable group id
                }));
            },
            showIntersection: function(i) {
                let isSelf = i.player == this.playerId
                if (isSelf) {
                    this.stealNotification = "You were caught!"
                    let that = this
                    setTimeout(function(){ that.stealNotification = ''; }, 2000);
                }
                let selector = '#indicator' + i.property + '-' + i.player
                gsap.to(selector, 0, {left: i.x-15, top: i.y-10})
                gsap.to(selector, {visibility: 'visible'})
                gsap.to(selector, {visibility: 'hidden', delay: 2})
            },
            addMessage(message) {
                if (message['test']) {
                    this.singleMessage = message['test']
                    return;
                }
                this.messages.push(message)
            }
        },
    });
</script>
{% endverbatim %}
